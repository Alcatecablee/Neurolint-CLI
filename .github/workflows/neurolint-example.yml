name: NeuroLint Security & Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  neurolint:
    name: Run NeuroLint Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Example 1: Run all 8 layers (comprehensive check)
      # This scans the root directory since we don't have ./src yet
      - name: NeuroLint - All Layers (Dry Run)
        id: neurolint-all
        uses: Alcatecablee/Neurolint-CLI@v1
        with:
          layers: 'all'
          path: '.'
          dry-run: 'true'
          verbose: 'true'

      # Example 2: Security-focused check (Layers 1, 4, 5, 8)
      # Layer 1: Config vulnerabilities
      # Layer 4: Hydration safety (SSR bugs)
      # Layer 5: Next.js optimization
      # Layer 8: Security forensics & CVEs
      - name: NeuroLint - Security Check
        id: neurolint-security
        uses: Alcatecablee/Neurolint-CLI@v1
        with:
          layers: '1,4,5,8'
          path: '.'
          dry-run: 'true'

      # Example 3: Code quality check (Layers 2, 3, 6, 7)
      # Layer 2: Pattern fixes
      # Layer 3: Component best practices
      # Layer 6: Testing infrastructure
      # Layer 7: Adaptive learning
      - name: NeuroLint - Code Quality Check
        id: neurolint-quality
        uses: Alcatecablee/Neurolint-CLI@v1
        with:
          layers: '2,3,6,7'
          path: '.'
          dry-run: 'true'

      # Example 4: Fast security scan (Layer 8 only - IoC & CVE detection)
      - name: NeuroLint - Security Forensics
        id: neurolint-forensics
        uses: Alcatecablee/Neurolint-CLI@v1
        with:
          layers: '8'
          path: '.'
          fail-on-changes: 'false'  # Changed to false so workflow doesn't fail

      # Example 5: Only scan JavaScript/TypeScript files
      - name: NeuroLint - JS/TS Only
        id: neurolint-jsts
        uses: Alcatecablee/Neurolint-CLI@v1
        with:
          layers: '1,2,3'
          path: '.'
          include: '**/*.{js,ts,jsx,tsx}'
          exclude: 'node_modules,dist,.github'
          dry-run: 'true'

      # Output results summary
      - name: Display Results
        if: always()
        run: |
          echo "## NeuroLint Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**All Layers Check:**" >> $GITHUB_STEP_SUMMARY
          echo "- Summary: ${{ steps.neurolint-all.outputs.summary }}" >> $GITHUB_STEP_SUMMARY
          echo "- Changes: ${{ steps.neurolint-all.outputs.changes-count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Files: ${{ steps.neurolint-all.outputs.affected-files }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Security Check:**" >> $GITHUB_STEP_SUMMARY
          echo "- Summary: ${{ steps.neurolint-security.outputs.summary }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Code Quality Check:**" >> $GITHUB_STEP_SUMMARY
          echo "- Summary: ${{ steps.neurolint-quality.outputs.summary }}" >> $GITHUB_STEP_SUMMARY

      # Comment PR with results (only on pull requests)
      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const summary = `
            ## ðŸ” NeuroLint Analysis Results
            
            ### All Layers Check
            **Summary:** ${{ steps.neurolint-all.outputs.summary }}
            **Changes Found:** ${{ steps.neurolint-all.outputs.changes-count }}
            **Files Affected:** ${{ steps.neurolint-all.outputs.affected-files }}
            **Layers Run:** ${{ steps.neurolint-all.outputs.layers-run }}
            
            ### Security Check
            **Summary:** ${{ steps.neurolint-security.outputs.summary }}
            
            ### Code Quality Check
            **Summary:** ${{ steps.neurolint-quality.outputs.summary }}
            
            ---
            > ðŸ’¡ To apply fixes locally, run: \`npx @neurolint/cli fix .\`
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
