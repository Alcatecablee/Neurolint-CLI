/**
 * Copyright (c) 2025 NeuroLint
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


/**
 * CVE-2025-55182 Security Patch Edge Case Tests
 * Tests for React Server Components RCE vulnerability detection and patching
 */

const path = require('path');
const fs = require('fs');
const { execSync } = require('child_process');

const {
  CVE_2025_55182,
  isVulnerableReactVersion,
  getPatchedReactVersion,
  isVulnerableNextVersion,
  getPatchedNextVersion,
  formatPatchedVersionsList
} = require('../shared-core/security-constants');

describe('CVE-2025-55182 Security Constants', () => {
  test('should have correct CVE metadata', () => {
    expect(CVE_2025_55182.id).toBe('CVE-2025-55182');
    expect(CVE_2025_55182.cvss).toBe(10.0);
    expect(CVE_2025_55182.severity).toBe('CRITICAL');
  });

  test('should list all vulnerable React versions', () => {
    expect(CVE_2025_55182.react.vulnerable).toContain('19.0.0');
    expect(CVE_2025_55182.react.vulnerable).toContain('19.0.1');
    expect(CVE_2025_55182.react.vulnerable).toContain('19.1.0');
    expect(CVE_2025_55182.react.vulnerable).toContain('19.1.1');
    expect(CVE_2025_55182.react.vulnerable).toContain('19.1.2');
    expect(CVE_2025_55182.react.vulnerable).toContain('19.2.0');
    expect(CVE_2025_55182.react.vulnerable).toContain('19.2.1');
    expect(CVE_2025_55182.react.vulnerable).not.toContain('18.0.0');
    expect(CVE_2025_55182.react.vulnerable).not.toContain('19.0.2');
  });

  test('should have patched versions for all vulnerable React major.minor', () => {
    expect(CVE_2025_55182.react.patched['19.0']).toBe('19.0.2');
    expect(CVE_2025_55182.react.patched['19.1']).toBe('19.1.3');
    expect(CVE_2025_55182.react.patched['19.2']).toBe('19.2.2');
  });

  test('should have patched versions for all Next.js major.minor', () => {
    expect(CVE_2025_55182.nextjs.patched['15.0']).toBe('15.0.5');
    expect(CVE_2025_55182.nextjs.patched['16.0']).toBe('16.0.7');
    expect(CVE_2025_55182.nextjs.patched['16.2']).toBe('16.2.1');
  });

  test('should list react-server-dom packages', () => {
    expect(CVE_2025_55182.serverDomPackages).toContain('react-server-dom-webpack');
    expect(CVE_2025_55182.serverDomPackages).toContain('react-server-dom-parcel');
    expect(CVE_2025_55182.serverDomPackages).toContain('react-server-dom-turbopack');
  });
});

describe('Vulnerable Version Detection', () => {
  describe('isVulnerableReactVersion', () => {
    test('should detect vulnerable React 19.0.0', () => {
      expect(isVulnerableReactVersion('19.0.0')).toBe(true);
      expect(isVulnerableReactVersion('^19.0.0')).toBe(true);
      expect(isVulnerableReactVersion('~19.0.0')).toBe(true);
    });

    test('should detect vulnerable React 19.1.0 and 19.1.1', () => {
      expect(isVulnerableReactVersion('19.1.0')).toBe(true);
      expect(isVulnerableReactVersion('19.1.1')).toBe(true);
    });

    test('should detect vulnerable React 19.2.0', () => {
      expect(isVulnerableReactVersion('19.2.0')).toBe(true);
      expect(isVulnerableReactVersion('^19.2.0')).toBe(true);
    });

    test('should detect partially patched React versions as vulnerable', () => {
      expect(isVulnerableReactVersion('19.0.1')).toBe(true);
      expect(isVulnerableReactVersion('19.1.2')).toBe(true);
      expect(isVulnerableReactVersion('19.2.1')).toBe(true);
    });

    test('should NOT detect fully patched React versions as vulnerable', () => {
      expect(isVulnerableReactVersion('19.0.2')).toBe(false);
      expect(isVulnerableReactVersion('19.1.3')).toBe(false);
      expect(isVulnerableReactVersion('19.2.2')).toBe(false);
    });

    test('should NOT detect versions above fully patched as vulnerable', () => {
      expect(isVulnerableReactVersion('19.0.3')).toBe(false);
      expect(isVulnerableReactVersion('19.0.5')).toBe(false);
      expect(isVulnerableReactVersion('19.1.4')).toBe(false);
      expect(isVulnerableReactVersion('19.1.5')).toBe(false);
      expect(isVulnerableReactVersion('19.2.3')).toBe(false);
      expect(isVulnerableReactVersion('19.2.5')).toBe(false);
    });

    test('should NOT detect React 18 as vulnerable', () => {
      expect(isVulnerableReactVersion('18.0.0')).toBe(false);
      expect(isVulnerableReactVersion('18.2.0')).toBe(false);
      expect(isVulnerableReactVersion('^18.3.1')).toBe(false);
    });

    test('should NOT detect React 17 as vulnerable', () => {
      expect(isVulnerableReactVersion('17.0.0')).toBe(false);
      expect(isVulnerableReactVersion('17.0.2')).toBe(false);
    });
  });

  describe('isVulnerableNextVersion', () => {
    test('should detect vulnerable Next.js 15.0.x versions', () => {
      expect(isVulnerableNextVersion('15.0.0')).toBe(true);
      expect(isVulnerableNextVersion('15.0.4')).toBe(true);
      expect(isVulnerableNextVersion('^15.0.3')).toBe(true);
    });

    test('should NOT detect patched Next.js 15.0.5+ as vulnerable', () => {
      expect(isVulnerableNextVersion('15.0.5')).toBe(false);
      expect(isVulnerableNextVersion('15.0.6')).toBe(false);
      expect(isVulnerableNextVersion('15.0.10')).toBe(false);
    });

    test('should detect vulnerable Next.js 16.0.x versions', () => {
      expect(isVulnerableNextVersion('16.0.0')).toBe(true);
      expect(isVulnerableNextVersion('16.0.1')).toBe(true);
      expect(isVulnerableNextVersion('^16.0.0')).toBe(true);
    });

    test('should NOT detect patched Next.js 16.0.7+ as vulnerable', () => {
      expect(isVulnerableNextVersion('16.0.7')).toBe(false);
      expect(isVulnerableNextVersion('16.0.8')).toBe(false);
    });

    test('should detect vulnerable Next.js 16.2.0 as vulnerable', () => {
      expect(isVulnerableNextVersion('16.2.0')).toBe(true);
    });

    test('should NOT detect patched Next.js 16.2.1+ as vulnerable', () => {
      expect(isVulnerableNextVersion('16.2.1')).toBe(false);
      expect(isVulnerableNextVersion('16.2.5')).toBe(false);
    });

    test('should NOT detect Next.js 14 as vulnerable', () => {
      expect(isVulnerableNextVersion('14.0.0')).toBe(false);
      expect(isVulnerableNextVersion('14.2.5')).toBe(false);
    });
  });
});

describe('Patched Version Retrieval', () => {
  describe('getPatchedReactVersion', () => {
    test('should return correct fully patched version for React 19.0.x', () => {
      expect(getPatchedReactVersion('19.0.0')).toBe('19.0.2');
      expect(getPatchedReactVersion('^19.0.0')).toBe('19.0.2');
    });

    test('should return correct fully patched version for React 19.1.x', () => {
      expect(getPatchedReactVersion('19.1.0')).toBe('19.1.3');
      expect(getPatchedReactVersion('19.1.1')).toBe('19.1.3');
    });

    test('should return correct fully patched version for React 19.2.x', () => {
      expect(getPatchedReactVersion('19.2.0')).toBe('19.2.2');
    });

    test('should return default patched version for unknown minor versions', () => {
      expect(getPatchedReactVersion('19.5.0')).toBe('19.2.2');
      expect(getPatchedReactVersion('19.9.0')).toBe('19.2.2');
    });
  });

  describe('getPatchedNextVersion', () => {
    test('should return correct patched version for Next.js 15.x', () => {
      expect(getPatchedNextVersion('15.0.0')).toBe('15.0.5');
      expect(getPatchedNextVersion('15.1.0')).toBe('15.1.9');
      expect(getPatchedNextVersion('15.5.0')).toBe('15.5.7');
    });

    test('should return correct patched version for Next.js 16.x', () => {
      expect(getPatchedNextVersion('16.0.0')).toBe('16.0.7');
      expect(getPatchedNextVersion('16.1.0')).toBe('16.1.0');
      expect(getPatchedNextVersion('16.2.0')).toBe('16.2.1');
    });

    test('should return undefined for versions without patches', () => {
      expect(getPatchedNextVersion('14.0.0')).toBeUndefined();
      expect(getPatchedNextVersion('17.0.0')).toBeUndefined();
    });
  });
});

describe('formatPatchedVersionsList', () => {
  test('should format React patched versions list', () => {
    const result = formatPatchedVersionsList('react');
    expect(result).toContain('19.0.2');
    expect(result).toContain('19.1.3');
    expect(result).toContain('19.2.2');
  });

  test('should format Next.js patched versions list', () => {
    const result = formatPatchedVersionsList('nextjs');
    expect(result).toContain('15.0.5+');
    expect(result).toContain('16.0.7+');
  });
});

describe('Edge Cases', () => {
  test('should handle version strings with various prefixes', () => {
    expect(isVulnerableReactVersion('^19.0.0')).toBe(true);
    expect(isVulnerableReactVersion('~19.0.0')).toBe(true);
    expect(isVulnerableReactVersion('>=19.0.0')).toBe(true);
    expect(isVulnerableReactVersion('<=19.0.0')).toBe(true);
    expect(isVulnerableReactVersion('>19.0.0')).toBe(false);
  });

  test('should handle empty or invalid version strings', () => {
    expect(isVulnerableReactVersion('')).toBe(false);
    expect(isVulnerableNextVersion('')).toBe(false);
  });

  test('should correctly identify boundary versions', () => {
    expect(isVulnerableNextVersion('15.0.4')).toBe(true);
    expect(isVulnerableNextVersion('15.0.5')).toBe(false);
    expect(isVulnerableNextVersion('16.0.6')).toBe(true);
    expect(isVulnerableNextVersion('16.0.7')).toBe(false);
  });
});

describe('Safe Path Verification (Not Affected)', () => {
  test('React 18 projects should not be flagged', () => {
    expect(isVulnerableReactVersion('18.0.0')).toBe(false);
    expect(isVulnerableReactVersion('18.2.0')).toBe(false);
    expect(isVulnerableReactVersion('18.3.1')).toBe(false);
  });

  test('React 17 projects should not be flagged', () => {
    expect(isVulnerableReactVersion('17.0.2')).toBe(false);
  });

  test('Next.js 14 and earlier should not be flagged', () => {
    expect(isVulnerableNextVersion('14.0.0')).toBe(false);
    expect(isVulnerableNextVersion('14.2.5')).toBe(false);
    expect(isVulnerableNextVersion('13.5.0')).toBe(false);
  });

  test('Fully patched React 19 versions should not be flagged', () => {
    expect(isVulnerableReactVersion('19.0.2')).toBe(false);
    expect(isVulnerableReactVersion('19.1.3')).toBe(false);
    expect(isVulnerableReactVersion('19.2.2')).toBe(false);
    expect(isVulnerableReactVersion('19.2.5')).toBe(false);
  });
});

describe('CLI Security Command Integration', () => {
  const cliPath = path.join(__dirname, '..', 'cli.js');
  
  function runSecurityCommand(args = '') {
    try {
      const result = execSync(`node "${cliPath}" security:cve-2025-55182 . ${args}`, {
        encoding: 'utf8',
        cwd: path.join(__dirname, '..'),
        timeout: 30000
      });
      return { stdout: result, stderr: '', exitCode: 0 };
    } catch (error) {
      return { 
        stdout: error.stdout || '', 
        stderr: error.stderr || '', 
        exitCode: error.status || 1 
      };
    }
  }

  test('security command should exist and show CVE header', () => {
    const result = runSecurityCommand('');
    const output = result.stdout + result.stderr;
    expect(output).toMatch(/CVE-2025-55182|CRITICAL SECURITY VULNERABILITY/i);
  });

  test('security command dry-run should not modify files', () => {
    const packageJsonBefore = fs.readFileSync(
      path.join(__dirname, '..', 'package.json'), 
      'utf8'
    );
    
    runSecurityCommand('--dry-run');
    
    const packageJsonAfter = fs.readFileSync(
      path.join(__dirname, '..', 'package.json'), 
      'utf8'
    );
    
    expect(packageJsonAfter).toBe(packageJsonBefore);
  });

  test('security command should report project status correctly', () => {
    const result = runSecurityCommand('');
    const output = result.stdout + result.stderr;
    expect(output).toMatch(/vulnerable|safe|No vulnerable packages|Found \d+ vulnerable/i);
  });
});
